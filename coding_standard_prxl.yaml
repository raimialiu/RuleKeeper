# Parallex Bank IT Coding Standard & API Policy
# RuleKeeper Configuration File

version: "1.0"

metadata:
  name: "Parallex Bank Coding Standards"
  description: "Code quality rules for Parallex Bank - Banking and Financial Services"
  author: "Parallex Bank IT Team"
  created: "2024-01-01"
  updated: "2026-01-26"

scan:
  languages: [csharp, typescript, javascript]
  include:
    - "**/*.cs"
    - "**/*.ts"
    - "**/*.js"
  exclude:
    - "**/obj/**"
    - "**/bin/**"
    - "**/node_modules/**"
    - "**/dist/**"
    - "**/*.Designer.cs"
    - "**/*.g.cs"
    - "**/*.generated.cs"
    - "**/Migrations/**"
    - "**/wwwroot/**"
    - "**/*.d.ts"
  parallel: true
  cache: true
  baseline:
    enabled: false
    mode: git
    git_ref: main
    include_uncommitted: true
    include_untracked: true
    filter_to_diff: true
    on_missing: warn

output:
  format: console
  min_severity: info
  fail_on: high
  show_code: true
  show_hints: true
  colors: true

prebuilt_policies:
  security:
    enabled: true
    severity: critical
    exclude:
      - "**/Tests/**"
      - "**/*.Tests.cs"
    skip_rules:
      - CS-SEC-005  # Skip path traversal for legacy code

  async_best_practices:
    enabled: true
    severity: high
    skip_rules: []

  naming_conventions:
    enabled: true
    severity: medium

  design:
    enabled: true
    severity: medium

  exceptions:
    enabled: true
    severity: high

  dependency_injection:
    enabled: true
    severity: medium

coding_standards:
  naming:
    enabled: true
    skip: false
    skip_rules: []
    rules:
      class_naming:
        id: PRXL-NAME-001
        name: "Class Naming Convention"
        description: "Classes must use PascalCase naming"
        severity: medium
        skip: false
        parameters:
          style: pascal_case
          allow_underscores: false

      method_naming:
        id: PRXL-NAME-002
        name: "Method Naming Convention"
        description: "Methods must use PascalCase naming"
        severity: medium
        parameters:
          style: pascal_case

      variable_naming:
        id: PRXL-NAME-003
        name: "Variable Naming Convention"
        description: "Variables, fields, and parameters must use camelCase"
        severity: medium
        parameters:
          style: camel_case

      constant_naming:
        id: PRXL-NAME-004
        name: "Constant Naming Convention"
        description: "Constants must use UPPER_SNAKE_CASE"
        severity: medium
        parameters:
          style: upper_snake_case

      private_field_naming:
        id: PRXL-NAME-005
        name: "Private Field Naming Convention"
        description: "Private fields must use _camelCase (underscore prefix)"
        severity: medium
        parameters:
          require_underscore_prefix: true

      async_method_naming:
        id: PRXL-NAME-006
        name: "Async Method Naming"
        description: "Async methods must end with 'Async' suffix"
        severity: medium
        parameters:
          require_suffix: true
          exclude_event_handlers: true

      interface_naming:
        id: PRXL-NAME-007
        name: "Interface Naming Convention"
        description: "Interfaces must start with 'I' prefix"
        severity: medium
        parameters:
          require_i_prefix: true

  file_organization:
    enabled: true
    rules:
      single_class_per_file:
        id: PRXL-ORG-001
        name: "Single Class Per File"
        description: "Each file should contain only one class"
        severity: medium

      file_class_name_match:
        id: PRXL-ORG-002
        name: "File Name Matches Class"
        description: "File name must match the class name it contains"
        severity: medium

  design:
    enabled: true
    rules:
      method_length:
        id: PRXL-DESIGN-001
        name: "Method Length"
        description: "Methods should be small - maximum 30 lines"
        severity: medium
        parameters:
          max_lines: 30
          count_blank_lines: false

      parameter_count:
        id: PRXL-DESIGN-002
        name: "Parameter Count"
        description: "Avoid long parameter lists - use DTOs instead"
        severity: medium
        parameters:
          max_parameters: 5

      cyclomatic_complexity:
        id: PRXL-DESIGN-003
        name: "Cyclomatic Complexity"
        description: "Methods should have low cyclomatic complexity"
        severity: medium
        parameters:
          max_complexity: 10

      single_responsibility:
        id: PRXL-DESIGN-004
        name: "Single Responsibility"
        description: "Methods should do one thing"
        severity: low
        skip: true  # Skipped - difficult to enforce automatically

  security:
    enabled: true
    severity: critical
    rules:
      sql_injection:
        id: PRXL-SEC-001
        name: "SQL Injection Prevention"
        description: "Never concatenate SQL or user inputs - use parameterized queries"
        severity: critical
        anti_pattern_match:
          regex: "FromSqlRaw\\s*\\(\\s*\\$|ExecuteSqlRaw\\s*\\(\\s*\\$|SqlCommand\\s*\\([^)]*\\+|\"SELECT.*\\+.*\"|'SELECT.*\\+.*'"
          message_template: "Potential SQL injection vulnerability - use parameterized queries"
        fix_hint: "Use parameterized queries with @parameters instead of string concatenation"

      no_hardcoded_secrets:
        id: PRXL-SEC-002
        name: "No Hardcoded Secrets"
        description: "No secrets in source code or appsettings.json"
        severity: critical
        anti_pattern_match:
          regex: "(password|secret|apikey|api_key|connectionstring|pwd)\\s*[=:]\\s*[\"'][^\"']{8,}[\"']"
          options: [ignorecase]
          message_template: "Potential hardcoded secret detected: {match}"
        fix_hint: "Use environment variables, Azure Key Vault, or AWS Secrets Manager"
        exclude:
          - "**/appsettings.Development.json"
          - "**/*.Test*.cs"

      input_validation:
        id: PRXL-SEC-003
        name: "Input Validation Required"
        description: "Always validate user input"
        severity: high

      sensitive_data_logging:
        id: PRXL-SEC-004
        name: "No Sensitive Data in Logs"
        description: "Sanitize logs - no sensitive data (PIN, password, token)"
        severity: critical
        anti_pattern_match:
          regex: "Log(Information|Warning|Error|Debug)\\s*\\([^)]*\\b(password|pin|token|secret|apikey|creditcard|ssn|cvv)\\b"
          options: [ignorecase]
          message_template: "Potential sensitive data in log statement"
        fix_hint: "Remove sensitive data from log messages or mask the values"

      cors_any_origin:
        id: PRXL-SEC-005
        name: "CORS Any Origin Prohibited"
        description: "Do not use AllowAnyOrigin() in CORS configuration"
        severity: critical
        anti_pattern_match:
          regex: "\\.AllowAnyOrigin\\s*\\(\\s*\\)"
          message_template: "AllowAnyOrigin() is prohibited - specify allowed origins explicitly"
        fix_hint: "Use WithOrigins() to specify allowed domains"

      secure_string_usage:
        id: PRXL-SEC-006
        name: "Use SecureString for Secrets"
        description: "Avoid keeping secrets as plain strings in memory"
        severity: high
        skip: true  # Skipped - SecureString is deprecated in .NET Core

      weak_encryption:
        id: PRXL-SEC-007
        name: "Use Strong Encryption"
        description: "Use proper RSA encryption with OAEP padding"
        severity: critical
        anti_pattern_match:
          regex: "Convert\\.ToBase64String\\s*\\(\\s*Encoding\\.(UTF8|ASCII)\\.GetBytes"
          message_template: "Base64 encoding is not encryption - use proper RSA encryption"
        fix_hint: "Use RSA.Encrypt with RSAEncryptionPadding.OaepSHA256"

  exceptions:
    enabled: true
    rules:
      empty_catch:
        id: PRXL-EXC-001
        name: "No Empty Catch Blocks"
        description: "Catch blocks should not be empty - handle or log exceptions"
        severity: high
        parameters:
          allow_comment: false

      catching_base_exception:
        id: PRXL-EXC-002
        name: "Avoid Catching Base Exception"
        description: "Catch specific exceptions, not System.Exception"
        severity: medium
        parameters:
          allow_rethrow: true
          allow_logging: true

      domain_exceptions:
        id: PRXL-EXC-003
        name: "Use Domain-Specific Exceptions"
        description: "Throw domain-specific exceptions when needed"
        severity: low

  async:
    enabled: true
    rules:
      no_blocking_async:
        id: PRXL-ASYNC-001
        name: "No Blocking on Async"
        description: "Don't block async with .Result or .Wait() - deadlock risk"
        severity: critical
        anti_pattern_match:
          regex: "\\.(Result|Wait)\\s*[;\\)]"
          message_template: "Blocking on async code detected - use await instead"
        fix_hint: "Use 'await' instead of .Result or .Wait()"
        parameters:
          allow_in_main: false

      async_void:
        id: PRXL-ASYNC-002
        name: "No Async Void"
        description: "Always await async calls - avoid async void except for event handlers"
        severity: high
        parameters:
          allow_event_handlers: true

      configure_await:
        id: PRXL-ASYNC-003
        name: "Use ConfigureAwait in Libraries"
        description: "Use ConfigureAwait(false) in library code"
        severity: low
        skip: true  # Skipped for application code
        exclude:
          - "**/Controllers/**"
          - "**/Pages/**"
          - "**/Views/**"

  dependency_injection:
    enabled: true
    rules:
      interface_dependency:
        id: PRXL-DI-001
        name: "Depend on Interfaces"
        description: "Depend on interfaces, not concrete types"
        severity: high

      avoid_new_in_logic:
        id: PRXL-DI-002
        name: "Avoid New in Business Logic"
        description: "Use dependency injection instead of 'new' inside business logic"
        severity: medium

      no_service_locator:
        id: PRXL-DI-003
        name: "No Service Locator Anti-Pattern"
        description: "Avoid service locator pattern - use constructor injection"
        severity: high
        anti_pattern_match:
          regex: "IServiceProvider\\.GetService|GetRequiredService"
          message_template: "Service locator pattern detected - use constructor injection"

  constants:
    enabled: true
    rules:
      magic_numbers:
        id: PRXL-CONST-001
        name: "No Magic Numbers"
        description: "Avoid magic numbers in code - use named constants or enums"
        severity: medium
        parameters:
          allowed_numbers: [0, 1, -1, 2, 100]
          check_strings: false

      magic_strings:
        id: PRXL-CONST-002
        name: "No Magic Strings"
        description: "Avoid magic strings - use constants or resource files"
        severity: low

  validation:
    enabled: true
    rules:
      dto_validation:
        id: PRXL-VAL-001
        name: "DTO Validation Required"
        description: "Always validate input DTOs using attributes or FluentValidation"
        severity: high

      account_number_validation:
        id: PRXL-VAL-002
        name: "Account Number Validation"
        description: "Account numbers must be validated with proper regex"
        severity: critical

  logging:
    enabled: true
    rules:
      structured_logging:
        id: PRXL-LOG-001
        name: "Use Structured Logging"
        description: "Use structured logging with named parameters"
        severity: medium
        anti_pattern_match:
          regex: "Log(Information|Warning|Error|Debug)\\s*\\(\\s*\\$\""
          message_template: "Use structured logging instead of string interpolation"
        fix_hint: "Use _logger.LogInformation(\"Message {Param}\", value) instead of $\"Message {value}\""

      log_levels:
        id: PRXL-LOG-002
        name: "Appropriate Log Levels"
        description: "Use appropriate log levels (Info, Warning, Error, Critical)"
        severity: low

  documentation:
    enabled: false  # Disabled entirely - team prefers minimal comments
    skip: true
    rules:
      xml_comments:
        id: PRXL-DOC-001
        name: "Public API Documentation"
        description: "Document public APIs appropriately"
        severity: low
        skip: true

      redundant_comments:
        id: PRXL-DOC-002
        name: "No Redundant Comments"
        description: "Comment why, not what - avoid redundant comments"
        severity: info

  immutability:
    enabled: true
    rules:
      readonly_fields:
        id: PRXL-IMM-001
        name: "Use Readonly for Fields"
        description: "Use readonly for fields that shouldn't change"
        severity: medium

      mutable_collections:
        id: PRXL-IMM-002
        name: "No Mutable Collection Exposure"
        description: "Avoid exposing mutable collections"
        severity: medium

      public_fields:
        id: PRXL-IMM-003
        name: "No Public Fields"
        description: "Use properties instead of public fields"
        severity: high
        ast_query:
          node_kinds: [FieldDeclaration]
          properties:
            IsPublic: true
            IsConst: false

  testing:
    enabled: true
    rules:
      test_naming:
        id: PRXL-TEST-001
        name: "Clear Test Names"
        description: "Use clear test names: MethodName_StateUnderTest_ExpectedBehavior"
        severity: medium
        anti_pattern_match:
          regex: "\\[Test\\]\\s*public\\s+\\w+\\s+Test\\d+\\s*\\("
          message_template: "Test name should follow pattern: MethodName_StateUnderTest_ExpectedBehavior"

      single_assertion:
        id: PRXL-TEST-002
        name: "Single Assertion Per Test"
        description: "Tests should have one assertion per test"
        severity: low
        skip: true  # Skipped - multiple assertions often make sense

  api:
    enabled: true
    rules:
      cors_configuration:
        id: PRXL-API-001
        name: "Proper CORS Configuration"
        description: "CORS must specify allowed origins explicitly"
        severity: critical

      controller_validation:
        id: PRXL-API-002
        name: "Controller Input Validation"
        description: "All API inputs must be validated"
        severity: high

      idempotency_keys:
        id: PRXL-API-003
        name: "Idempotency Keys for Mutations"
        description: "POST/PUT/DELETE endpoints should support idempotency keys"
        severity: high

      restful_endpoints:
        id: PRXL-API-004
        name: "RESTful Endpoint Design"
        description: "Use proper HTTP methods for RESTful endpoints"
        severity: medium
        anti_pattern_match:
          regex: "\\[Http(Get|Post)\\s*\\(\\s*\"(get|delete|update|create)"
          options: [ignorecase]
          message_template: "Use proper HTTP verbs instead of action names in routes"

      http_status_codes:
        id: PRXL-API-005
        name: "Proper HTTP Status Codes"
        description: "Return appropriate HTTP status codes"
        severity: medium

      api_versioning:
        id: PRXL-API-006
        name: "API Versioning Required"
        description: "APIs must be versioned"
        severity: high

      response_consistency:
        id: PRXL-API-007
        name: "Consistent API Responses"
        description: "Use consistent response format (ApiResponse<T>)"
        severity: medium

      rate_limiting:
        id: PRXL-API-008
        name: "Rate Limiting Required"
        description: "API endpoints should have rate limiting"
        severity: high

      controller_logging:
        id: PRXL-API-009
        name: "Controller Logging Required"
        description: "Log important operations in controllers"
        severity: medium

      authorization_required:
        id: PRXL-API-010
        name: "Authorization Required"
        description: "API endpoints must have authorization"
        severity: critical
        anti_pattern_match:
          regex: "\\[Http(Get|Post|Put|Delete|Patch)\\](?!.*\\[Authorize)"
          message_template: "API endpoint missing [Authorize] attribute"
        exclude:
          - "**/HealthController.cs"
          - "**/StatusController.cs"

      controller_error_handling:
        id: PRXL-API-011
        name: "Controller Error Handling"
        description: "Controllers should handle exceptions properly"
        severity: high

      data_sanitization:
        id: PRXL-API-012
        name: "Data Sanitization Required"
        description: "Sanitize user input before processing"
        severity: critical

      content_negotiation:
        id: PRXL-API-013
        name: "Content Negotiation Support"
        description: "APIs should support content negotiation"
        severity: low
        skip: true  # Skipped - not required for internal APIs

      api_documentation:
        id: PRXL-API-014
        name: "API Documentation Required"
        description: "APIs must have proper documentation"
        severity: medium

custom_validators:
  no_console_output:
    enabled: true
    skip: false
    description: "Prevent Console.WriteLine in production code"
    type: regex
    regex: "Console\\.(WriteLine|Write|ReadLine|ReadKey)\\s*\\("
    message_template: "Console I/O detected - use proper logging instead"
    severity: medium
    exclude:
      - "**/Program.cs"
      - "**/*.Test*.cs"

  todo_comments:
    enabled: true
    description: "Detect TODO/FIXME comments that need attention"
    type: regex
    regex: "//\\s*(TODO|FIXME|HACK|XXX):"
    message_template: "Found {match} comment that needs attention"
    severity: info

  hardcoded_connection_string:
    enabled: true
    description: "Detect hardcoded database connection strings"
    type: regex
    regex: "Server\\s*=\\s*[^;]+;\\s*Database\\s*=\\s*[^;]+;\\s*(User\\s*Id|Password)\\s*="
    options: [ignorecase]
    message_template: "Hardcoded connection string detected"
    severity: critical

  deprecated_api:
    enabled: false
    skip: true  # Skipped - handled by compiler warnings
    description: "Detect usage of deprecated APIs"
    type: regex
    regex: "\\[Obsolete"
    message_template: "Usage of deprecated/obsolete API detected"
    severity: warning

custom_rules: []
